---
// Components
import Header from "../components/header/Header.astro";
import ProductModal from "../components/product/ProductModal.astro";
import Toast from "../components/Toast.astro";
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!--begin::Fonts-->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700"
    />
    <!--end::Fonts-->
    <!--begin::Global Stylesheets Bundle(used by all pages)-->
    <link
      href="/assets/plugins/global/plugins.bundle.css"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="/assets/css/style.bundle.css"
      rel="stylesheet"
      type="text/css"
    />
    <!--end::Global Stylesheets Bundle-->
    <title>Test App</title>
  </head>
  <body id="kt_body" class="bg-body">
    <div class="d-flex flex-column flex-root app-root" id="kt_app_root">
      <div class="app-page flex-column flex-column-fluid" id="kt_app_page">
        <!--begin::Header-->
        <Header />
        <!--end::Header-->
        <!--begin::Main content-->
        <div class="d-flex flex-column flex-column-fluid" id="main_content">
          <slot />
        </div>
        <!--end::Main content-->
        <!--begin::Product Modal-->
        <ProductModal />
        <!--end::Product Modal-->
        <!--begin::Toast-->
        <Toast />
        <!--end::Toast-->
      </div>
    </div>
    <!--begin::Global Javascript Bundle-->
    <script is:inline src="/assets/plugins/global/plugins.bundle.js"></script>
    <script is:inline src="/assets/js/scripts.bundle.js"></script>
    <!--end::Global Javascript Bundle-->
  </body>
</html>

<script>
  //////////////////////////////////////////
  // Show toast function
  const showToast = (title: string, message: string) => {
    // Get toast elements
    const toastEl = document.querySelector(".toast") as HTMLElement
    const titleEl = toastEl.querySelector(".me-auto") as HTMLElement
    const bodyEl = toastEl.querySelector(".toast-body") as HTMLElement

    // Set title and message
    titleEl.textContent = title
    bodyEl.textContent = message

    // Show notification
    toastEl.classList.remove("hide")
    toastEl.classList.add("show")
  }
  //////////////////////////////////////////
  // Update cart items
  const updateCartItems = async(actionName: string, productId: number) => {
    // Get cart
    fetch(`${import.meta.env.PUBLIC_SERVER_URL}/api/users/me/?populate=deep,3`, {
      headers: new Headers({
        'Authorization': `Bearer ${document.cookie.slice(10)}`, 
        'Content-Type': 'application/x-www-form-urlencoded'
      }),
    })
    .then(res => res.json())
    .then(data => {
      let updatedCart = data.cart;

      // Updated cart after deleting cartItem
      if(actionName === 'delete') {
        // Update user cart, need only product ids --> example [3, 4, 6]
        updatedCart = updatedCart
          .filter((cartItem: { id: number }) => cartItem.id !== productId)
          .map((cartItem: { id: number }) => cartItem.id)
      }

      // Updated cart after adding cartItem
      if(actionName === 'add') {
        // Update user cart, need only product ids --> example [3, 4, 6]
        updatedCart = updatedCart.map((cartItem: { id: number }) => cartItem.id)
        
        // Check if item is already in the cart
        if(updatedCart.indexOf(productId) === 1) {
          // If yes, show toast notification
          showToast("Cart", "Product is already in your cart!")
          return
        }
        if(updatedCart.indexOf(productId) === -1) {
          // If not, add it to the cart
          updatedCart.push(productId)
        }
      }
      fetch(`${import.meta.env.PUBLIC_SERVER_URL}/api/users/${data.id}`, {
        method: "PUT",
        headers: new Headers({
          'Authorization': `Bearer ${document.cookie.slice(10)}`, 
          'Content-Type': 'application/json'
        }),
        body: JSON.stringify({cart: [...updatedCart]})
      })
      .then(res => showToast("Success", "Update the page to see the difference!"))
    })
    .catch(err => showToast("Error", "Something went wrong :("))
  }
  //////////////////////////////////////////
  // Sign out
  const signOutBtn = document.querySelector("#sign_out") as HTMLElement
  signOutBtn.addEventListener("click", function() {
    // Delete cookie using 'cookie' endpoint
    fetch(`${import.meta.env.PUBLIC_CLIENT_URL}/cookie`)
    .then(res => {
      // Redirect
      window.location.href = "/auth/signin"
    })
    .catch(err => showToast("Error", "Something went wrong :("))
  })
  //////////////////////////////////////////
  // Delete cart item
  const cart = document.querySelector("#cart") as HTMLElement
  cart.addEventListener('click', event => {
    const element = event.target as HTMLElement
    if (element.classList.contains("delete_btn")) {
      // Get product id
      const cartItemToDeleteId = +element.getAttribute("data-id")!;
      // Delete it from the cart
      updateCartItems("delete", cartItemToDeleteId)
    }
  })
  //////////////////////////////////////////
  // Add to cart
  const container = document.querySelector("#main_content") as HTMLElement
  // Add event listener
  container.addEventListener('click', event => {
    const element = event.target as HTMLElement
    if (element.classList.contains("add_btn")) {
      // Get product id
      const cartItemToAddId = +element.getAttribute("data-id")!;
      // Add it to the cart
      updateCartItems("add", cartItemToAddId)
    }
  })
</script>