---
// Components
import Layout from "../../layouts/Layout.astro";
import AuthForm from "../../components/auth/AuthForm.astro";
---

<Layout>
  <AuthForm isSigninPage={true} />
</Layout>

<script>
  // Show toast function
  const showToast = (title: string, message: string) => {
    // Get toast elements
    const toastEl = document.querySelector(".toast") as HTMLElement
    const titleEl = toastEl.querySelector(".me-auto") as HTMLElement
    const bodyEl = toastEl.querySelector(".toast-body") as HTMLElement

    // Set title and message
    titleEl.textContent = title
    bodyEl.textContent = message

    // Show notification
    toastEl.classList.remove("hide")
    toastEl.classList.add("show")
  }
  //////////////////////////////////////////
  // Sign in
  // Get form
  const form = document.querySelector(".form") as HTMLFormElement;
  // Add event listener
  form.addEventListener("submit", function(e) {
    e.preventDefault()
    // Get data from the form
    const payload = new FormData(form)
    // Try to sign in
    fetch(`${import.meta.env.PUBLIC_SERVER_URL}/api/auth/local`, {
        method: "POST", body: payload
      })
    .then(res => res.json())
    .then(data => {
      if(data.jwt) {
        // Success! Save jwt token to cookie using 'cookie' endpoint
        fetch(`${import.meta.env.PUBLIC_CLIENT_URL}/cookie`, {
          method: "POST", headers: {"Authorization": `${data.jwt}`},
        })
        .then(res => {
          // Redirect
          window.location.href = "/products"
        })
      } else {
        showToast("Error", "Wrong credentials. Try again!")
      }
    })
    .catch(err => showToast("Error", "Something went wrong :("))
  }
)
</script>